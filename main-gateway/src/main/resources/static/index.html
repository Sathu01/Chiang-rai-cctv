<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Camera Admin (Firestore)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="config.js"></script>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <!-- Firebase compat (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏ô‡∏ß v8 ‡πÑ‡∏î‡πâ) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    body { padding-bottom: 80px; }
    .table-actions { white-space: nowrap; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container-fluid">
      <span class="navbar-brand fw-semibold">Camera Admin</span>
      <div class="ms-auto">
        <button id="btnReload" class="btn btn-outline-secondary btn-sm">Reload</button>
        <button id="btnAdd" class="btn btn-primary btn-sm ms-2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <h5 class="card-title mb-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡πâ‡∏≠‡∏á (collection: <code>cameras</code>)</h5>
          <div class="ms-auto small text-muted mx-1" id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>

          <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° -->
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden />
          <button id="btnImport" class="btn btn-outline-primary btn-sm">Import</button>
          <button id="btnTemplate" class="btn btn-outline-secondary btn-sm ms-2">Download Template</button>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle" id="tblCameras">
            <thead class="table-light">
              <tr>
                <th style="width: 20%">‡∏ä‡∏∑‡πà‡∏≠</th>
                <th style="width: 18%">‡∏û‡∏¥‡∏Å‡∏±‡∏î (lat_long)</th>
                <th style="width: 27%">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (address)</th>
                <th style="width: 20%">URL (RTSP)</th>
                <th style="width: 15%"></th>
              </tr>
            </thead>
            <tbody>
              <!-- rows injected here -->
            </tbody>
          </table>
        </div>

        <div id="emptyState" class="text-center text-muted py-4 d-none">
          <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
          <button class="btn btn-sm btn-primary mt-2" id="btnAdd2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Add/Edit -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="cameraForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Å‡∏•‡πâ‡∏≠‡∏á</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="docId" />
          <div class="mb-3">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠ (name) <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="name" required />
          </div>
          <div class="mb-3">
            <label class="form-label">‡∏û‡∏¥‡∏Å‡∏±‡∏î (lat_long) <span class="text-muted">(‡πÄ‡∏ä‡πà‡∏ô 19.9367,99.8325)</span></label>
            <input type="text" class="form-control" id="lat_long" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î" />
          </div>
          <div class="mb-3">
            <label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (address)</label>
            <input type="text" class="form-control" id="address" />
          </div>
          <div class="mb-0">
            <label class="form-label">URL</label>
            <input type="text" class="form-control" id="URL" placeholder="‡πÄ‡∏ä‡πà‡∏ô rtsp:// ‡∏´‡∏£‡∏∑‡∏≠ http(s)://" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="btn btn-primary" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Preview -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered table-sm" id="previewTable"></table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="button" class="btn btn-primary" id="confirmImport">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>

    firebase.initializeApp(window.firebaseConfig);
    const db = firebase.firestore();
    const col = db.collection('cameras');

    // UI refs
    const $tbody = $('#tblCameras tbody');
    const statusText = document.getElementById('statusText');
    const editModal = new bootstrap.Modal('#editModal');
    const previewModal = new bootstrap.Modal('#previewModal');
    let importData = [];  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
    const form = document.getElementById('cameraForm');

    // Render row
    function rowTemplate(id, data) {
      const name = data.name || '';
      let latlong = '';
      let mapsLink = '';
      if (data.lat_long) {
        // üîπ Firestore GeoPoint
        if (typeof data.lat_long.latitude === 'number' && typeof data.lat_long.longitude === 'number') {
          const lat = data.lat_long.latitude.toFixed(5);
          const lng = data.lat_long.longitude.toFixed(5);
          latlong = `${lat}, ${lng}`;
          mapsLink = `https://www.google.com/maps?q=${lat},${lng}`;
        }
        // üîπ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string (‡πÄ‡∏Å‡πá‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)
        else if (typeof data.lat_long === 'string' && data.lat_long.includes(',')) {
          latlong = data.lat_long;
          const parts = data.lat_long.split(',');
          mapsLink = `https://www.google.com/maps?q=${parts[0].trim()},${parts[1].trim()}`;
        }
      }

      const address = data.address || '';
      const url = data.URL || data.url || '';

      return `
        <tr data-id="${id}">
          <td class="fw-semibold">${escapeHtml(name)}</td>
          <td><code>${escapeHtml(latlong)}</code>
            ${latlong ? `
              <a href="${mapsLink}" target="_blank" class="btn btn-sm btn-outline-primary ms-2" title="‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
                <i class="bi bi-geo-alt"></i>
              </a>` : ''}
          </td>
          <td>
            <div class="d-flex align-items-center justify-content-between">
              <span class="flex-grow-1">${escapeHtml(address)}</span>
            </div>
          </td>
          <td style="max-width:220px; white-space:normal; word-wrap:break-word;">
            ${url ? `<a href="${escapeAttr(url)}" target="_blank" rel="noopener">${escapeHtml(url)}</a>` : ''}
          </td>
          <td class="table-actions text-end">
            <button class="btn btn-sm btn-outline-secondary me-1 btn-edit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-sm btn-outline-danger btn-del">‡∏•‡∏ö</button>
          </td>
        </tr>`;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á GeoPoint ‡∏´‡∏£‡∏∑‡∏≠ string ‚Üí string "lat,lng"
    function formatLatLngForInput(val) {
      if (!val) return '';
      if (typeof val === 'string') return val.trim();
      if (typeof val.latitude === 'number' && typeof val.longitude === 'number') {
        return `${val.latitude},${val.longitude}`;
      }
      return '';
    }

    // ‡πÅ‡∏õ‡∏•‡∏á string ‚Üí { geoPoint | null }  (‡∏Ñ‡∏∑‡∏ô null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà valid/‡∏ß‡πà‡∏≤‡∏á)
    function parseLatLngFromInput(s) {
      if (!s) return null;
      const txt = String(s).trim().replace(/\s+/g, '');
      const m = txt.match(/^(-?\d+(\.\d+)?),(-?\d+(\.\d+)?)$/);
      if (!m) return null;
      const lat = parseFloat(m[1]);
      const lng = parseFloat(m[3]);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
      return new firebase.firestore.GeoPoint(lat, lng);
    }

    // Escape helpers (‡∏Å‡∏±‡∏ô XSS ‡∏á‡πà‡∏≤‡∏¢‡πÜ)
    function escapeHtml(s) {
      if (typeof s !== 'string') s = String(s || '');
      return s.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    function escapeAttr(s) {
      if (typeof s !== 'string') s = String(s || '');
      return s.replace(/"/g, '&quot;');
    }

    // Load (Realtime)
    let unsubscribe = null;
    function attachRealtime() {
      if (unsubscribe) unsubscribe();
      statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
      unsubscribe = col.orderBy('name', 'asc').onSnapshot(snap => {
        $tbody.empty();
        if (snap.empty) {
          $('#emptyState').removeClass('d-none');
        } else {
          $('#emptyState').addClass('d-none');
          snap.forEach(doc => $tbody.append(rowTemplate(doc.id, doc.data())));
        }
        statusText.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
      }, err => {
        console.error(err);
        statusText.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
      });
    }

    $('#btnImport').on('click', () => {
      $('#fileInput').val('');    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
      $('#fileInput')[0].click(); // ‡πÄ‡∏õ‡∏¥‡∏î dialog
    });

    $('#fileInput').on('change', handleImport);

    // 2.  ‡πÉ‡∏ä‡πâ XLSX.read() ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå -> ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô array
    function handleImport(e){
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(evt){
        const wb = XLSX.read(evt.target.result, { type: 'binary' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        let rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false }); // array of arrays

        if (rows.length) rows = rows.slice(1);

        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 1..4 => name, lat_long, address, url
        const data = rows
          .map(r => ({
            name: (r[0] || '').toString().trim(),
            lat_long: (r[1] || '').toString().trim(),
            address: (r[2] || '').toString().trim(),
            url: (r[3] || '').toString().trim()
          }))
          // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÜ (‡πÑ‡∏°‡πà‡∏°‡∏µ name ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πá‡∏ß‡πà‡∏≤‡∏á)
          .filter(d => d.name || d.lat_long || d.address || d.url);

        previewInModal(data);
      };
      reader.readAsBinaryString(file);
    }

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô modal preview (bootstrap table)
    function previewInModal(data){
      importData = data; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô confirm

      // ‡∏ß‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (name, lat_long, address, url)
      const $tbl = $('#previewTable');
      const head = `
        <thead class="table-light">
          <tr>
            <th style="width:25%">‡∏ä‡∏∑‡πà‡∏≠ (name)</th>
            <th style="width:20%">‡∏û‡∏¥‡∏Å‡∏±‡∏î (lat,long)</th>
            <th style="width:35%">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (address)</th>
            <th style="width:20%">URL</th>
          </tr>
        </thead>`;
      const body = `
        <tbody>
          ${data.map(r => `
            <tr>
              <td>${escapeHtml(r.name || '')}</td>
              <td><code>${escapeHtml(r.lat_long || '')}</code></td>
              <td>${escapeHtml(r.address || '')}</td>
              <td style="max-width:260px; white-space:normal; word-wrap:break-word;">
                ${r.url ? `<a href="${escapeAttr(r.url)}" target="_blank" rel="noopener">${escapeHtml(r.url)}</a>` : ''}
              </td>
            </tr>
          `).join('')}
        </tbody>`;

      $tbl.html(head + body);

      // ‡πÄ‡∏õ‡∏¥‡∏î modal (Bootstrap 5)
      previewModal.show();
    }

    // 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Confirm -> add() ‡πÄ‡∏Ç‡πâ‡∏≤ Firestore
    $('#confirmImport').on('click', async () => {
      if (!importData.length) { previewModal.hide(); return; }

      try {
        for (const d of importData) {
          const geo = parseLatLngFromInput(d.lat_long);
          await col.add({
            name: (d.name || '').trim(),
            address: (d.address || '').trim(),
            url: (d.url || '').trim(),
            ...(geo ? { lat_long: geo } : {})
          });
        }
        previewModal.hide();
      } catch (err) {
        console.error(err);
        alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    });

    $('#btnTemplate').on('click', ()=>{
      const ws = XLSX.utils.aoa_to_sheet([['‡∏ä‡∏∑‡πà‡∏≠ (name)', '‡∏û‡∏¥‡∏Å‡∏±‡∏î (lat,long)', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (address)', 'URL']]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Template');
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      saveAs(new Blob([wbout], {type:'application/octet-stream'}), 'cameras_template.xlsx');
    });

    // Add
    function openAddModal() {
      $('#editModalLabel').text('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á');
      $('#docId').val('');
      $('#name,#lat_long,#address,#URL').val('');
      editModal.show();
    }

    // Edit
    function openEditModal(id) {
      col.doc(id).get().then(d => {
        if (!d.exists) return;
        const data = d.data() || {};
        $('#editModalLabel').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡πâ‡∏≠‡∏á');
        $('#docId').val(id);
        $('#name').val(data.name || '');
        // üîπ ‡πÅ‡∏™‡∏î‡∏á lat_long ‡πÄ‡∏õ‡πá‡∏ô "lat,lng" ‡πÄ‡∏™‡∏°‡∏≠
        $('#lat_long').val(formatLatLngForInput(data.lat_long));
        $('#address').val(data.address || '');
        // üîπ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á URL ‡πÅ‡∏•‡∏∞ url ‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        $('#URL').val(data.URL || data.url || '');
        editModal.show();
      });
    }

    // Save (create/update)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = $('#docId').val().trim();
      const name = $('#name').val().trim();
      const latStr = $('#lat_long').val().trim();
      const address = $('#address').val().trim();
      const urlInput = $('#URL').val().trim(); // üîπ ‡∏£‡∏±‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

      if (!name) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ (name)');
        return;
      }

      // üîπ ‡πÅ‡∏õ‡∏•‡∏á lat_long string ‚Üí GeoPoint (‡∏ñ‡πâ‡∏≤ valid)
      const geo = parseLatLngFromInput(latStr);

      // üîπ payload: normalize ‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏•‡∏î‡πå 'url' (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å) ‡πÄ‡∏™‡∏°‡∏≠
      const payload = {
        name,
        address,
        url: urlInput
      };

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ lat_long: set ‡πÄ‡∏õ‡πá‡∏ô GeoPoint ‡∏ñ‡πâ‡∏≤ valid, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡∏•‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå
      if (geo) {
        payload.lat_long = geo;
      } else {
        payload.lat_long = firebase.firestore.FieldValue.delete();
      }

      try {
        if (id) {
          await col.doc(id).set(payload, { merge: true });
        } else {
          await col.add(payload);
        }
        editModal.hide();
      } catch (err) {
        console.error(err);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    });

    // Delete
    function deleteDoc(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
      col.doc(id).delete().catch(err => {
        console.error(err);
        alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      });
    }

    // Events
    $('#btnAdd, #btnAdd2').on('click', openAddModal);
    $('#btnReload').on('click', attachRealtime);

    // Delegate table actions
    $tbody.on('click', '.btn-edit', function() {
      const id = $(this).closest('tr').data('id');
      openEditModal(id);
    });
    $tbody.on('click', '.btn-del', function() {
      const id = $(this).closest('tr').data('id');
      deleteDoc(id);
    });

    // Init
    attachRealtime();
  </script>
</body>
</html>
